<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Redirect to HTTPS if not already
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
    
    # Handle Authorization Header
    RewriteCond %{HTTP:Authorization} .
    RewriteRule ^ - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
    
    # Redirect to index.php for Nextcloud front controller
    RewriteRule ^\.well-known/carddav /remote.php/dav/ [R=301,L]
    RewriteRule ^\.well-known/caldav /remote.php/dav/ [R=301,L]
    
    # The following rules are handled by Nextcloud's .htaccess
    RewriteRule ^\.well-known/webfinger /index.php/.well-known/webfinger [END,R=301,L]
    RewriteRule ^\.well-known/nodeinfo /index.php/.well-known/nodeinfo [END,R=301,L]
    RewriteRule ^\.well-known/host-meta /public.php?service=host-meta [QSA,L]
    RewriteRule ^\.well-known/host-meta\.json /public.php?service=host-meta-json [QSA,L]
    
    # Let Nextcloud's front controller handle the rest
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule . /index.php [L]
</IfModule>
