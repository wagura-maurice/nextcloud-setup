<VirtualHost *:80>
    ServerName your-domain.com
    ServerAdmin wagura465@gmail.com
    DocumentRoot /var/www/nextcloud

    <Directory /var/www/nextcloud/>
        Options +FollowSymlinks
        AllowOverride All
        Require all granted
        
        <IfModule mod_dav.c>
            Dav off
        </IfModule>
        
        SetEnv HOME /var/www/nextcloud
        SetEnv HTTP_HOME /var/www/nextcloud
    </Directory>

    # The following lines prevent .user.ini files from being viewed by Web clients.
    <FilesMatch "\.user\.ini">
        Require all denied
    </FilesMatch>

    # The following rule prevents HTTP clients from viewing the contents of directories
    <DirectoryMatch "^/\..*">
        Require all denied
    </DirectoryMatch>

    # The following rule prevents HTTP clients from viewing files that might contain sensitive information
    <FilesMatch "\.(?:db|sqlite|sqlite3|log|md|gitignore|gitattributes|yml|yaml|dist|swp|bak|bak2|save|swo|orig|example|sample|test|sh|php[0-9]?|phps|phtml|inc|tpl|twig)$|^\..*$">
        Require all denied
    </FilesMatch>

    # Set default character set
    AddDefaultCharset UTF-8

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/nextcloud_error.log
    LogLevel warn
    CustomLog ${APACHE_LOG_DIR}/nextcloud_access.log combined

    # Redirect to HTTPS (will be handled by certbot)
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName your-domain.com
    ServerAdmin wagura465@gmail.com
    DocumentRoot /var/www/nextcloud

    <Directory /var/www/nextcloud/>
        Options +FollowSymlinks
        AllowOverride All
        Require all granted
        
        <IfModule mod_dav.c>
            Dav off
        </IfModule>
        
        SetEnv HOME /var/www/nextcloud
        SetEnv HTTP_HOME /var/www/nextcloud
    </Directory>

    # The following lines prevent .user.ini files from being viewed by Web clients.
    <FilesMatch "\.user\.ini">
        Require all denied
    </FilesMatch>

    # The following rule prevents HTTP clients from viewing the contents of directories
    <DirectoryMatch "^/\..*">
        Require all denied
    </DirectoryMatch>

    # The following rule prevents HTTP clients from viewing files that might contain sensitive information
    <FilesMatch "\.(?:db|sqlite|sqlite3|log|md|gitignore|gitattributes|yml|yaml|dist|swp|bak|bak2|save|swo|orig|example|sample|test|sh|php[0-9]?|phps|phtml|inc|tpl|twig)$|^\..*$">
        Require all denied
    </FilesMatch>

    # Set default character set
    AddDefaultCharset UTF-8

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/nextcloud_ssl_error.log
    LogLevel warn
    CustomLog ${APACHE_LOG_DIR}/nextcloud_ssl_access.log combined

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile      /etc/letsencrypt/live/your-domain.com/fullchain.pem
    SSLCertificateKeyFile   /etc/letsencrypt/live/your-domain.com/privkey.pem
    SSLCertificateChainFile /etc/letsencrypt/live/your-domain.com/chain.pem

    # SSL Protocol Adjustments:
    SSLProtocol             all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite          ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder     off
    SSLCompression          off
    SSLSessionTickets       off
    
    # HSTS (uncomment after testing)
    # Header always set Strict-Transport-Security "max-age=15552000; includeSubDomains; preload"
    
    # OCSP Stapling
    SSLUseStapling          on
    SSLStaplingResponderTimeout 5
    SSLStaplingReturnResponderErrors off
    SSLStaplingCache        shmcb:/var/run/ocsp(128000)

    # HTTP/2 support
    Protocols h2 http/1.1

    # Security headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Robots-Tag "none"
    Header always set X-Download-Options "noopen"
    Header always set X-Permitted-Cross-Domain-Policies "none"
    Header always set Referrer-Policy "no-referrer"
    
    # Disable TRACE method
    TraceEnable off
    
    # Disable ETags
    FileETag None
    
    # Set timeouts
    TimeOut 600
    
    # Enable KeepAlive
    KeepAlive On
    MaxKeepAliveRequests 100
    KeepAliveTimeout 5
</VirtualHost>
</IfModule>
