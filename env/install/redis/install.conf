# Redis installation configuration

# Dependencies to install
DEPENDENCIES="redis-server"

# Service name (if different from component name)
SERVICE_NAME="redis-server"

# Check if Redis is already installed
is_installed() {
    if command -v redis-server >/dev/null 2>&1; then
        return 0
    fi
    return 1
}

# Install Redis
install_component() {
    print_status "Installing Redis..."
    apt-get update
    apt-get install -y $DEPENDENCIES
}

# Configure Redis
configure_component() {
    print_status "Configuring Redis..."
    
    # Backup existing config
    local redis_conf="/etc/redis/redis.conf"
    if [ -f "$redis_conf" ]; then
        cp "$redis_conf" "${redis_conf}.bak.$(date +%Y%m%d%H%M%S)"
    fi
    
    # Apply our configuration
    if [ -f "$CONFIG_DIR/redis.conf" ]; then
        cp "$CONFIG_DIR/redis.conf" "$redis_conf"
        chown redis:redis "$redis_conf"
        chmod 640 "$redis_conf"
    fi
    
    # Configure systemd service
    if [ -f "$CONFIG_DIR/redis.service" ]; then
        cp "$CONFIG_DIR/redis.service" "/etc/systemd/system/"
        systemctl daemon-reload
    fi
}

# Post-installation steps
post_install() {
    # Enable and start Redis
    systemctl enable --now redis-server
    
    # Test Redis connection
    if redis-cli ping >/dev/null 2>&1; then
        print_success "Redis is running and responding to ping"
    else
        print_error "Failed to connect to Redis"
        return 1
    fi
}
