; PHP configuration for Nextcloud
; This file should be applied to all PHP configurations (Apache2, CLI, and FPM)

[PHP]
; Maximum execution time of each script, in seconds (60 minutes for long-running operations)
max_execution_time = 3600

; Maximum amount of time each script may spend parsing request data (5 minutes)
max_input_time = 1000

; Maximum amount of memory a script may consume (512MB)
memory_limit = 512M

; Maximum size of POST data that PHP will accept (slightly larger than upload_max_filesize)
post_max_size = 97M

; Maximum allowed size for uploaded files (96MB)
upload_max_filesize = 96M

; Temporary directory for file uploads
upload_tmp_dir = /var/www/nextcloud/tmp
sys_temp_dir = /var/www/nextcloud/tmp

; Maximum number of files that can be uploaded via a single request
max_file_uploads = 20

; Maximum number of input variables (for large forms)
max_input_vars = 3000

; Default timeout for socket based streams (in seconds)
default_socket_timeout = 60

; Disable PHP version information in headers (security)
expose_php = Off

; Disable dangerous functions (security)
disable_functions = exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source,phpinfo,dl,passthru,escapeshellarg,escapeshellcmd,pcntl_exec,shell_exec,proc_close,proc_get_status,proc_nice,proc_open,proc_terminate,show_source,symlink

; Error handling
display_errors = stderr
display_startup_errors = off
log_errors = on
log_errors_max_len = 0
ignore_repeated_errors = off
ignore_repeated_source = off
report_memleaks = on
track_errors = off
html_errors = off

; Session handling (consolidated)
session.save_handler = redis
session.save_path = "unix:///var/run/redis/redis.sock?persistent=1&weight=1&database=0"
session.cookie_httponly = 1
session.cookie_secure = 1
session.use_strict_mode = 1
session.cookie_samesite = Lax
session.gc_maxlifetime = 14400

; OPcache settings
[opcache]
opcache.enable = 1
opcache.enable_cli = 1
opcache.interned_strings_buffer = 16
opcache.max_accelerated_files = 10000
opcache.memory_consumption = 128
opcache.revalidate_freq = 60
opcache.save_comments = 1
opcache.fast_shutdown = 1
opcache.huge_code_pages = 1
opcache.file_cache = /var/www/nextcloud/.opcache
opcache.validate_timestamps = 1
opcache.revalidate_path = 1
opcache.jit_buffer_size = 100M
opcache.jit = 1255

; Realpath cache settings
[realpath_cache]
realpath_cache_size = 4096K
realpath_cache_ttl = 600

; Date settings
date.timezone = Africa/Nairobi

; Mail function
[mail function]
SMTP = localhost
smtp_port = 25
mail.add_x_header = On

; MySQLi settings
[mysqli]
mysqli.max_persistent = -1

; PostgreSQL settings
[pgsql]
pgsql.allow_persistent = On
pgsql.auto_reset_persistent = Off
pgsql.max_persistent = -1
pgsql.max_links = -1

; SQLite3 settings
[sqlite3]
extension = sqlite3.so

; Redis session handler
[Session]
session.save_handler = redis
session.save_path = "unix:///var/run/redis/redis.sock?persistent=1&weight=1&database=0"
redis.session.locking_enabled = 1
redis.session.lock_retries = -1
redis.session.lock_wait_time = 10000

; Performance optimizations
opcache.enable_file_override = 1
opcache.use_cwd = 1
opcache.validate_root = 1
opcache.optimization_level = 0x7FFEBFFF
opcache.inherited_hack = 1
opcache.dups_fix = 0
opcache.revalidate_path = 0
opcache.log_verbosity_level = 1

; JIT settings
[opcache.jit]
jit = 1255
jit_buffer_size = 100M
jit_debug = 0

; PHP-FPM specific settings (will be applied to FPM pool)
[PHP-FPM]
pm = dynamic
pm.max_children = 64
pm.start_servers = 16
pm.min_spare_servers = 16
pm.max_spare_servers = 32
pm.max_requests = 500
request_terminate_timeout = 300s
request_slowlog_timeout = 10s
slowlog = /var/log/php8.4-fpm/nextcloud-slow.log

; Error logging for FPM
php_admin_value[error_log] = /var/log/php8.4-fpm/nextcloud-error.log
php_admin_flag[log_errors] = on
php_admin_value[log_errors_max_len] = 0
php_admin_value[display_errors] = stderr

; OPcache settings
opcache.enable = 1
opcache.enable_cli = 1
opcache.interned_strings_buffer = 16
opcache.max_accelerated_files = 10000
opcache.memory_consumption = 128
opcache.revalidate_freq = 60
opcache.save_comments = 1
opcache.fast_shutdown = 1
opcache.huge_code_pages = 1
opcache.file_cache = /var/www/nextcloud/.opcache
opcache.validate_timestamps = 1
opcache.revalidate_path = 1
opcache.jit_buffer_size = 100M
opcache.jit = 1255

; Realpath cache settings
realpath_cache_size = 4096K
realpath_cache_ttl = 600

; File uploads
file_uploads = On
upload_tmp_dir = /var/www/nextcloud/tmp/
sys_temp_dir = /var/www/nextcloud/tmp/

; Character encoding
mbstring.func_overload = 0
mbstring.internal_encoding = UTF-8
mbstring.http_input = UTF-8
mbstring.http_output = UTF-8
mbstring.encoding_translation = Off

default_charset = UTF-8

; Output buffering
output_buffering = 0

; Mail function
[mail function]
SMTP = localhost
smtp_port = 25
mail.add_x_header = On

; SQLite3 module
[sqlite3]
sqlite3.extension_dir =

; MySQLi
[mysqli]
mysqli.max_persistent = -1

; PostgreSQL
[pgsql]
pgsql.allow_persistent = On
pgsql.auto_reset_persistent = Off
pgsql.max_persistent = -1
pgsql.max_links = -1

; Redis session handler
[Session]
session.save_handler = redis
session.save_path = "unix:///var/run/redis/redis.sock?persistent=1&weight=1&database=0"
redis.session.locking_enabled = 1
redis.session.lock_retries = -1
redis.session.lock_wait_time = 10000

; Additional settings
[opcache]
opcache.enable_file_override = 1
opcache.use_cwd = 1
opcache.validate_root = 1
opcache.optimization_level = 0x7FFEBFFF
opcache.inherited_hack = 1
opcache.dups_fix = 0
opcache.revalidate_path = 0
opcache.log_verbosity_level = 1
opcache.memory_consumption = 128
opcache.interned_strings_buffer = 16
opcache.max_accelerated_files = 10000
opcache.max_wasted_percentage = 5
opcache.consistency_checks = 0
opcache.force_restart_timeout = 180
opcache.revalidate_freq = 60
opcache.preferred_memory_model =
opcache.blacklist_filename =
opcache.max_file_size = 0
opcache.error_log =
opcache.protect_memory = 0
opcache.restrict_api =
opcache.mmap_base =
opcache.cache_id =
opcache.file_update_protection = 2
opcache.validate_permission = 0
opcache.validate_root = 0
opcache.huge_code_pages = 1

; JIT settings
[opcache.jit]
opcache.jit = 1255
opcache.jit_buffer_size = 100M
opcache.jit_debug = 0

; PHP-FPM specific settings
[PHP-FPM]
pm = dynamic
pm.max_children = 64
pm.start_servers = 16
pm.min_spare_servers = 16
pm.max_spare_servers = 32
pm.max_requests = 500
request_terminate_timeout = 300s
request_slowlog_timeout = 10s
slowlog = /var/log/php8.4-fpm/nextcloud-slow.log

; Error logging for FPM
php_admin_value[error_log] = /var/log/php8.4-fpm/nextcloud-error.log
php_admin_flag[log_errors] = on
php_admin_value[log_errors_max_len] = 0
php_admin_value[display_errors] = stderr
